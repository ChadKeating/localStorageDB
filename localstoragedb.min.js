/*
	Kailash Nadh (http://kailashnadh.name)
	
	localStorageDB
	September 2011
	A simple database layer for localStorage

	License	:	MIT License
*/

function localStorageDB(e){function s(){delete localStorage[n];i=null}function o(){var e=0;for(var t in i.tables){if(i.tables.hasOwnProperty(t)){e++}}return e}function u(e){return i.tables[e]?true:false}function a(e){if(!u(e)){S("The table '"+e+"' does not exist.")}}function f(e,t){i.tables[e]={fields:t,auto_increment:1};i.data[e]={}}function l(e){delete i.tables[e];delete i.data[e]}function c(e){i.tables[e].auto_increment=1;i.data[e]={}}function h(e){var t=0;for(var n in i.data[e]){if(i.data[e].hasOwnProperty(n)){t++}}return t}function p(e,t){t.ID=i.tables[e].auto_increment;i.data[e][i.tables[e].auto_increment]=t;i.tables[e].auto_increment++;return t.ID}function d(e,t){var n=null,r=[],s=null;for(var o=0;o<t.length;o++){n=t[o];s=i.data[e][n];r.push(x(s))}return r}function v(e,t,n){var r=[],s=false,o=null;for(var u in i.data[e]){if(!i.data[e].hasOwnProperty(u)){continue}o=i.data[e][u];s=false;for(var a in t){if(!t.hasOwnProperty(a)){continue}if(typeof t[a]=="string"){if(o[a].toString().toLowerCase()==t[a].toString().toLowerCase()){s=true;break}}else{if(o[a]==t[a]){s=true;break}}}if(s){r.push(u)}if(r.length==n){break}}return r}function m(e,t,n){var r=[],s=false,o=null;for(var u in i.data[e]){if(!i.data[e].hasOwnProperty(u)){continue}o=i.data[e][u];if(t(x(o))==true){r.push(u)}if(r.length==n){break}}return r}function g(e,t){var n=[];for(var r in i.data[e]){if(i.data[e].hasOwnProperty(r)){n.push(r);if(n.length==t){break}}}return n}function y(e,t){for(var n=0;n<t.length;n++){if(i.data[e].hasOwnProperty(t[n])){delete i.data[e][t[n]]}}return t.length}function b(e,t,n){var r="",s=0;for(var o=0;o<t.length;o++){r=t[o];var u=n(x(i.data[e][r]));if(u){delete u["ID"];var a=i.data[e][r];for(var f in u){if(u.hasOwnProperty(f)){a[f]=u[f]}}i.data[e][r]=N(e,a);s++}}return s}function w(){localStorage[n]=JSON.stringify(i)}function E(){return JSON.stringify(i)}function S(e){throw new Error(e)}function x(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t}function T(e){return e.match(/[^a-z_0-9]/ig)?false:true}function N(e,t){var n="",r={};for(var s=0;s<i.tables[e].fields.length;s++){n=i.tables[e].fields[s];if(t[n]){r[n]=t[n]}}return r}function C(e,t){var n="",r={};for(var s=0;s<i.tables[e].fields.length;s++){n=i.tables[e].fields[s];r[n]=t[n]?t[n]:null}return r}var t="db_",n=t+e,r=false,i=null;i=localStorage[n];if(!(i&&(i=JSON.parse(i))&&i.tables&&i.data)){if(!T(e)){S("The name '"+e+"'"+" contains invalid characters.")}else{i={tables:{},data:{}};w();r=true}}return{commit:function(){w()},isNew:function(){return r},drop:function(){s()},serialize:function(){return E()},tableExists:function(e){return u(e)},tableCount:function(){return o()},createTable:function(e,t){var n=false;if(!T(e)){S("The database name '"+e+"'"+" contains invalid characters.")}else if(this.tableExists(e)){S("The table name '"+e+"' already exists.")}else{var r=true;for(var i=0;i<t.length;i++){if(!T(t[i])){r=false;break}}if(r){var s={};for(var i=0;i<t.length;i++){s[t[i]]=true}delete s["ID"];t=["ID"];for(var o in s){if(s.hasOwnProperty(o)){t.push(o)}}f(e,t);n=true}else{S("One or more field names in the table definition contains invalid characters.")}}return n},dropTable:function(e){a(e);l(e)},truncate:function(e){a(e);c(e)},rowCount:function(e){a(e);return h(e)},insert:function(e,t){a(e);return p(e,C(e,t))},insertOrUpdate:function(e,t,n){a(e);var r=[];if(!n){r=g(e)}else if(typeof n=="object"){r=v(e,N(e,n))}else if(typeof n=="function"){r=m(e,n)}if(r.length==0){return p(e,C(e,t))}else{var i=[];for(var s=0;s<r.length;s++){b(e,r,function(e){i.push(e.ID);return t})}return i}},update:function(e,t,n){a(e);var r=[];if(!t){r=g(e)}else if(typeof t=="object"){r=v(e,N(e,t))}else if(typeof t=="function"){r=m(e,t)}return b(e,r,n)},query:function(e,t,n){a(e);var r=[];if(!t){r=g(e,n)}else if(typeof t=="object"){r=v(e,N(e,t),n)}else if(typeof t=="function"){r=m(e,t,n)}return d(e,r,n)},deleteRows:function(e,t){a(e);var n=[];if(!t){n=g(e)}else if(typeof t=="object"){n=v(e,N(e,t))}else if(typeof t=="function"){n=m(e,t)}return y(e,n)}}};
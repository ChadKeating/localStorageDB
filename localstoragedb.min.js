/*
	Kailash Nadh (http://kailashnadh.name)
	
	localStorageDB
	September 2011
	A simple database layer for localStorage

	License	:	MIT License
*/

function localStorageDB(a){function x(a,b){var c="",d={};for(var f in e.tables[a].fields){c=e.tables[a].fields[f];d[c]=b[c]?b[c]:null}return d}function w(a,b){var c="",d={};for(var f in e.tables[a].fields){c=e.tables[a].fields[f];if(b[c]){d[c]=b[c]}}return d}function v(a){return a.match(/[^a-z_0-9]/ig)?false:true}function u(a){var b={};for(var c in a){b[c]=a[c]}return b}function t(a){throw new Error(a)}function s(){return JSON.stringify(e)}function r(){localStorage[c]=JSON.stringify(e)}function q(a,b,c){var d="",f=0;for(var g in b){d=b[g];var h=c(u(e.data[a][d]));if(h){delete h["ID"];var i=e.data[a][d];for(var j in h){i[j]=h[j]}e.data[a][d]=w(a,i);f++}}return f}function p(a,b){for(var c in b){delete e.data[a][b[c]]}return b.length}function o(a,b,c){var d=[],f=false,g=null;for(var h in e.data[a]){g=e.data[a][h];if(b(u(g))==true){d.push(h)}if(d.length==c){break}}return d}function n(a,b,c){var d=[],f=false,g=null;for(var h in e.data[a]){g=e.data[a][h];f=false;for(var i in b){if(typeof b[i]=="string"){if(g[i].toString().toLowerCase()==b[i].toString().toLowerCase()){f=true;break}}else{if(g[i]==b[i]){f=true;break}}}if(f){d.push(h)}if(d.length==c){break}}return d}function m(a,b){var c=null,d=[],f=null;for(var g in b){c=b[g];f=e.data[a][c];d.push(u(f))}return d}function l(a,b){b.ID=e.tables[a].auto_increment;e.data[a][e.tables[a].auto_increment]=b;e.tables[a].auto_increment++;return b.ID}function k(a){var b=0;for(var c in e.data[a]){b++}return b}function j(a){e.tables[a].auto_increment=1;e.data[a]={}}function i(a){delete e.tables[a];delete e.data[a]}function h(a,b){b.splice(b.indexOf("ID"),1);b.unshift("ID");e.tables[a]={fields:b,auto_increment:1};e.data[a]={}}function g(){var a=0;for(var b in e.tables){a++}return a}function f(){delete localStorage[c];e=null}var b="db_",c=b+a,d=false,e=null;e=localStorage[c];if(!(e&&(e=JSON.parse(e))&&e.tables&&e.data)){if(!v(a)){t("The name '"+a+"'"+" contains invalid characters.")}else{e={tables:{},data:{}};r();d=true}}return{commit:function(){r()},isNew:function(){return d},drop:function(){f()},serialize:function(){return s()},tableExists:function(a){return e.tables[a]?true:false},tableCount:function(){return g()},createTable:function(a,b){var c=false;if(!v(a)){t("The database name '"+a+"'"+" contains invalid characters.")}else if(this.tableExists(a)){t("The table name '"+a+"' already exists.")}else{var d=true;for(var e in b){if(!v(b[e])){d=false;break}}if(d){h(a,b);c=true}else{t("One or more field names in the table definition contains invalid characters.")}}return c},dropTable:function(a){if(tableExists(a)){i(a)}else{t("The table '"+a+"' does not exist.")}},truncate:function(a){if(tableExists(a)){j(a)}else{t("The table '"+a+"' does not exist.")}},rowCount:function(a){if(!this.tableExists(a)){t("The table '"+a+"' does not exist.")}else{return k(a)}},insert:function(a,b){if(!this.tableExists(a)){t("The table '"+a+"' does not exist.")}else{return l(a,x(a,b))}},update:function(a,b,c){var d=[];if(typeof b=="object"){d=n(a,w(a,b))}else if(typeof b=="function"){d=o(a,b)}return q(a,d,c)},query:function(a,b,c){if(typeof b=="object"){return m(a,n(a,w(a,b),c))}else if(typeof b=="function"){return m(a,o(a,b,c))}return[]},"delete":function(a,b){var c=[];if(typeof b=="object"){c=n(a,w(a,b))}else if(typeof b=="function"){c=o(a,b)}return p(a,c)}}}
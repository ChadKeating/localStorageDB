/*
	Kailash Nadh (http://kailashnadh.name)
	
	localStorageDB
	v1.0, September 2011
	A simple database layer for localStorage

	License	:	GNU Public License ( http://www.fsf.org/copyleft/gpl.html )
*/

function localStorageDB(a){function w(a,b){var c="",d={};for(var f in e.tables[a].fields){c=e.tables[a].fields[f];d[c]=b[c]?b[c]:null}return d}function v(a,b){var c="",d={};for(var f in e.tables[a].fields){c=e.tables[a].fields[f];if(b[c]){d[c]=b[c]}}return d}function u(a){return a.match(/[^a-z_0-9]/ig)?false:true}function t(a){var b={};for(var c in a){b[c]=a[c]}return b}function s(a){throw new Error(a)}function r(){localStorage[c]=JSON.stringify(e)}function q(a,b,c){var d="";for(var f in b){d=b[f];new_data=c(t(e.data[a][d]));if(new_data){e.data[a][d]=v(a,new_data)}}}function p(a,b){for(var c in b){delete e.data[a][b[c]]}}function o(a,b,c){var d=[],f=false,g=null;for(var h in e.data[a]){g=e.data[a][h];if(b(t(g))==true){d.push(h)}if(d.length==c){break}}return d}function n(a,b,c){var d=[],f=false,g=null;for(var h in e.data[a]){g=e.data[a][h];f=false;for(var i in b){if(typeof b[i]=="string"){if(g[i].toString().toLowerCase()==b[i].toString().toLowerCase()){f=true;break}}else{if(g[i]==b[i]){f=true;break}}}if(f){d.push(h)}if(d.length==c){break}}return d}function m(a,b){var c=null,d=[],f=null;for(var g in b){c=b[g];f=e.data[a][c];d.push(t(f))}return d}function l(a,b){b.ID=e.tables[a].auto_increment;e.data[a][e.tables[a].auto_increment]=b;e.tables[a].auto_increment++}function k(a){var b=0;for(var c in e.data[a]){b++}return b}function j(a){e.tables[a].auto_increment=1;e.data[a]={}}function i(a){delete e.tables[a];delete e.data[a]}function h(a,b){b.splice(b.indexOf("ID"),1);b.unshift("ID");e.tables[a]={fields:b,auto_increment:1};e.data[a]={}}function g(){var a=0;for(var b in e.tables){a++}return a}function f(){delete localStorage[c];e=null}var b="db_",c=b+a,d=false,e=null;e=localStorage[c];if(!(e&&(e=JSON.parse(e))&&e.tables&&e.data)){if(!u(a)){s("The name '"+a+"'"+" contains invalid characters.")}else{e={tables:{},data:{}};r();d=true}}return{commit:function(){r()},isNew:function(){return d},drop:function(){f()},tableExists:function(a){return e.tables[a]?true:false},tableCount:function(){return g()},createTable:function(a,b){var c=false;if(!u(a)){s("The database name '"+a+"'"+" contains invalid characters.")}else if(this.tableExists(a)){s("The table name '"+a+"' already exists.")}else{var d=true;for(var e in b){if(!u(b[e])){d=false;break}}if(d){h(a,b);c=true}else{s("One or more field names in the table definition contains invalid characters.")}}return c},dropTable:function(a){if(tableExists(a)){i(a)}else{s("The table '"+a+"' does not exist.")}},truncate:function(a){if(tableExists(a)){j(a)}else{s("The table '"+a+"' does not exist.")}},rowCount:function(a){if(!this.tableExists(a)){s("The table '"+a+"' does not exist.")}else{return k(a)}},insert:function(a,b){var c=false;if(!this.tableExists(a)){s("The table '"+a+"' does not exist.")}else{var b=w(a,b);l(a,b);c=true}return c},update:function(a,b,c){var d=[];if(typeof b=="object"){var e=v(a,b);d=n(a,e)}else if(typeof b=="function"){d=o(a,b)}q(a,d,c)},query:function(a,b,c){if(typeof b=="object"){var d=v(a,b);return m(a,n(a,d,c))}else if(typeof b=="function"){return m(a,o(a,b,c))}return[]},"delete":function(a,b){if(typeof b=="object"){var c=v(a,b);p(a,n(a,c))}else if(typeof b=="function"){p(a,o(a,b))}}}}